<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SP Tattoo Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>
<body class="bg-gray-900 text-white">

<!-- Booking Section -->
<section id="booking" class="container mx-auto px-6 py-10">
  <h1 class="text-3xl font-bold mb-6 text-center">Rezervacija Termina</h1>
  <form id="bookingForm" class="bg-gray-800 rounded-lg p-8 space-y-6">
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <!-- Calendar -->
        <div class="bg-gray-900 rounded-lg p-6 mb-8">
          <div class="flex justify-between items-center mb-6">
            <button type="button" onclick="changeMonth(-1)" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">‹</button>
            <h3 id="currentMonth" class="text-xl font-bold"></h3>
            <button type="button" onclick="changeMonth(1)" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">›</button>
          </div>

          <div class="grid grid-cols-7 text-center font-semibold mb-4">
            <div>Ned</div><div>Pon</div><div>Uto</div><div>Sre</div><div>Čet</div><div>Pet</div><div>Sub</div>
          </div>

          <div id="calendarDays" class="grid grid-cols-7 gap-2"></div>

          <div class="flex justify-center space-x-6 mt-6 text-sm">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-green-500 rounded"></div>
              <span>Dostupno</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-red-500 rounded"></div>
              <span>Zauzeto</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-blue-500 rounded"></div>
              <span>Izabrano</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-gray-500 rounded"></div>
              <span>Odbijeno</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-green-700 rounded"></div>
              <span>Potvrđeno</span>
            </div>
          </div>
        </div>

        <label class="block text-sm font-medium mb-2">Umetnik</label>
        <select id="artist" name="artist" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none">
          <option value="">Izaberite umetnika</option>
          <option value="Stefan">Stefan</option>
          <option value="Emilija">Emilija</option>
          <option value="Josipa">Josipa</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">Tip termina</label>
        <select id="sessionType" name="session_type" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none" onchange="updatePrice()">
          <option value="">Izaberite tip</option>
          <option value="small" data-price="150" data-deposit="100">Small Tattoo - 150€</option>
          <option value="half" data-price="300" data-deposit="150">Half Day - 300€</option>
          <option value="full" data-price="600" data-deposit="250">Full Day - 600€</option>
        </select>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2">Ime</label>
          <input type="text" id="firstName" name="first_name" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3">
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2">Prezime</label>
          <input type="text" id="lastName" name="last_name" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3">
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2">Broj telefona</label>
          <input type="tel" id="phone" name="phone" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3">
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium mb-2">Email</label>
          <input type="email" id="email" name="email" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3">
        </div>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-2">Opis tetovaže</label>
      <textarea id="description" name="description" required rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3" placeholder="Opišite tetovažu..."></textarea>
    </div>

    <div id="priceInfo" class="bg-gray-800 rounded-lg p-4 hidden">
      <div class="flex justify-between items-center">
        <span>Ukupna cena:</span>
        <span id="totalPrice" class="font-bold text-xl"></span>
      </div>
      <div class="flex justify-between items-center mt-2">
        <span>Depozit:</span>
        <span id="depositAmount" class="font-bold text-purple-400"></span>
      </div>
    </div>

    <div id="selectedDate" class="text-center text-purple-400 hidden">
      <p>Izabrani datum: <span id="dateDisplay"></span></p>
    </div>

    <!-- Hidden fields -->
    <input type="hidden" id="totalPriceHidden" name="total_price">
    <input type="hidden" id="depositHidden" name="deposit">
    <input type="hidden" id="dateHidden" name="date">

    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 py-4 rounded-lg font-semibold text-lg">
      Pošaljite Zahtev za Termin
    </button>
  </form>
</section>

<!-- Admin Panel -->
<section id="adminPanel" class="container mx-auto px-6 py-10">
  <h1 class="text-3xl font-bold mb-6 text-center">Admin Panel - Potvrda Termina</h1>
  <div id="requestsList" class="space-y-4"></div>
</section>

<!-- Info Table -->
<section id="info" class="bg-gray-800 text-white mt-10 py-8">
  <div class="container mx-auto px-6 grid md:grid-cols-4 gap-6 text-center">
    <div>
      <h3 class="font-bold text-lg mb-2">Adresa</h3>
      <p>Ulica 123, Beograd</p>
    </div>
    <div>
      <h3 class="font-bold text-lg mb-2">Radno vreme</h3>
      <p>Pon-Pet: 10:00 - 20:00</p>
      <p>Sub: 10:00 - 15:00</p>
    </div>
    <div>
      <h3 class="font-bold text-lg mb-2">WhatsApp</h3>
      <p><a href="https://wa.me/381601234567" target="_blank" class="text-green-400 hover:underline">+381 60 1234567</a></p>
    </div>
    <div>
      <h3 class="font-bold text-lg mb-2">Instagram</h3>
      <p><a href="https://instagram.com/sptattoo" target="_blank" class="text-pink-400 hover:underline">@sptattoo</a></p>
    </div>
  </div>
</section>

<script>
  emailjs.init("jqIOVZLJJvDFs6I2d"); // Tvoj EmailJS userID
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDmCJL8QSAifNUMib_KZ4jj14bLaAELaT",
    authDomain: "adminsptattoo.firebaseapp.com",
    projectId: "adminsptattoo",
    storageBucket: "adminsptattoo.firebasestorage.app",
    messagingSenderId: "1027852466595",
    appId: "1:1027852466595:web:394719d82a21b397a80216"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentDate = new Date();
  let selectedDate = null;
  let bookedDates = new Map();

  async function loadBookedDates(){
    bookedDates.clear();
    const querySnapshot = await getDocs(collection(db,"bookings"));
    querySnapshot.forEach(doc => {
      const data = doc.data();
      if(data.date) bookedDates.set(data.date,data.status);
    });
  }

  async function renderCalendar(){
    await loadBookedDates();
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    document.getElementById('currentMonth').textContent = currentDate.toLocaleString('sr-RS', {month:'long', year:'numeric'});
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML="";

    const firstDay = new Date(year,month,1).getDay();
    const daysInMonth = new Date(year,month+1,0).getDate();

    for(let i=0;i<firstDay;i++){ calendarDays.appendChild(document.createElement('div')); }

    for(let d=1; d<=daysInMonth; d++){
      const dayEl=document.createElement('div');
      const dateStr = new Date(year,month,d).toISOString().split('T')[0];
      dayEl.classList.add('day','bg-gray-800','p-2','text-center','rounded');

      dayEl.textContent=d;

      const status = bookedDates.get(dateStr);
      if(status==='confirmed'){dayEl.classList.add('bg-green-700');}
      else if(status==='pending'){dayEl.classList.add('bg-red-500');}
      else if(status==='rejected'){dayEl.classList.add('bg-gray-500');}
      else{dayEl.addEventListener('click',()=>selectDate(dateStr,dayEl));
            dayEl.classList.add('available','hover:bg-blue-700','cursor-pointer');}
      
      calendarDays.appendChild(dayEl);
    }
  }

  function changeMonth(step){ currentDate.setMonth(currentDate.getMonth()+step); renderCalendar(); }

  function selectDate(dateStr,el){
    document.querySelectorAll('.selected').forEach(x=>{x.classList.remove('selected'); x.classList.add('available');});
    el.classList.remove('available'); el.classList.add('selected');
    selectedDate=dateStr;
    document.getElementById('selectedDate').classList.remove('hidden');
    document.getElementById('dateDisplay').textContent=new Date(dateStr).toLocaleDateString('sr-RS');
  }

  window.updatePrice=function(){
    const select=document.getElementById('sessionType');
    const opt=select.options[select.selectedIndex];
    if(opt.value){
      const price=opt.dataset.price;
      const deposit=opt.dataset.deposit;
      document.getElementById('totalPrice').textContent=price+'€';
      document.getElementById('depositAmount').textContent=deposit+'€';
      document.getElementById('priceInfo').classList.remove('hidden');
    }else{document.getElementById('priceInfo').classList.add('hidden');}
  }

  async function loadRequests(){
    const container=document.getElementById('requestsList');
    container.innerHTML="";
    const snapshot=await getDocs(collection(db,'bookings'));
    snapshot.forEach(d=>{
      const data=d.data();
      if(data.status==='pending'){
        const card=document.createElement('div');
        card.className='bg-gray-800 p-4 rounded flex justify-between items-center';
        card.innerHTML=`
          <div>
            <p><strong>${data.first_name} ${data.last_name}</strong></p>
            <p>${data.date} - ${data.artist} - ${data.session_type}</p>
            <p>${data.description}</p>
          </div>
          <div class="flex space-x-2">
            <button class="bg-green-600 px-3 py-1 rounded approve">Potvrdi</button>
            <button class="bg-red-600 px-3 py-1 rounded reject">Odbij</button>
          </div>
        `;
        card.querySelector('.approve').addEventListener('click',()=>updateStatus(d.id,'confirmed'));
        card.querySelector('.reject').addEventListener('click',()=>updateStatus(d.id,'rejected'));
        container.appendChild(card);
      }
    });
  }

  async function updateStatus(id,status){
    await updateDoc(doc(db,'bookings',id),{status});
    renderCalendar();
    loadRequests();
  }

  document.getElementById('bookingForm').addEventListener('submit',async function(e){
    e.preventDefault();
    if(!selectedDate){alert('Molimo izaberite datum iz kalendara.'); return;}
    const formData={
      first_name: document.getElementById('firstName').value,
      last_name: document.getElementById('lastName').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      artist: document.getElementById('artist').value,
      session_type: document.getElementById('sessionType').value,
      description: document.getElementById('description').value,
      date:selectedDate,
      status:'pending',
      notified:false,
      timestamp:new Date().toISOString()
    };

    try{
      const docRef=await addDoc(collection(db,"bookings"),formData);

      if(!formData.notified){
        await emailjs.send('service_sptattoo','template_admin_notify',{
          client_name: formData.first_name+' '+formData.last_name,
          client_email: formData.email,
          date: formData.date,
          artist: formData.artist,
          session_type: formData.session_type,
          description: formData.description
        });
        await updateDoc(doc(db,"bookings",docRef.id),{notified:true});
      }

      alert('✅ Termin uspešno poslat!');
      this.reset();
      selectedDate=null;
      document.getElementById('selectedDate').classList.add('hidden');
      document.getElementById('priceInfo').classList.add('hidden');
      renderCalendar();
      loadRequests();
    }catch(err){console.error(err); alert('❌ Došlo je do greške.');}
  });

  renderCalendar();
  loadRequests();
</script>

</body>
</html>
